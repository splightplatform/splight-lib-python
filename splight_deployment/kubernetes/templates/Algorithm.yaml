apiVersion: apps/v1
kind: Deployment
metadata:
    namespace: {{ namespace }}
    name: "{{id}}"
    labels:
        id: "{{id}}"
        external_id: "{{external_id}}"
        type: "{{type}}"
        version: "{{version}}"
spec:
    replicas: 1
    selector:
        matchLabels:
            id: "{{id}}"
            external_id: "{{external_id}}"
            type: "{{type}}"
            version: "{{version}}"
    template:
        metadata:
            labels:
                id: "{{id}}"
                external_id: "{{external_id}}"
                type: "{{type}}"
                version: "{{version}}"
        spec:
            imagePullSecrets:
                - name: awsecr-cred
            serviceAccountName: {{serviceaccount}}
            serviceAccount: {{serviceaccount}}
            containers:
                - name: "{{id}}"
                  image: {{dockerimg}}
                  command: ["python", "runner.py"]
                  args: ["-r", '{{run_spec}}']
                  imagePullPolicy: "Always"
                  limits:
                    cpu: "{{cpu_limit}}"
                    memory: "{{memory_limit}}"
                  requests:
                    cpu: "{{cpu_requested}}"
                    memory: "{{memory_requested}}"
                  tty: true
                  livenessProbe:
                    exec:
                        command:
                          - sh
                          - -c
                          - ls /tmp/ | grep -q healthy_
                    initialDelaySeconds: 100
                    periodSeconds: 5
                  envFrom:
                    - configMapRef:
                        name: {{configmap}}
